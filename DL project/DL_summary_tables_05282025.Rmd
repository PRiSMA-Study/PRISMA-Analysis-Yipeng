---
title: "Summary Tables for ML/AI Project"
output:
  pdf_document: default
  html_document: default
date: "2025-04-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%") 
knitr::opts_chunk$set(out.width = "75%", fig.align = "center")

library(tidyverse)
library(gt)
library(naniar)

data.static<-read.csv("D:/Users/yipeng_wei/Documents/dl data/2025-04-18/df_dl_static.csv")
data.temporal.wide<-read.csv("D:/Users/yipeng_wei/Documents/dl data/2025-04-18/df_dl_temporal_wide.csv")

outcome_filters <- list(
  "Preterm Birth" = data.static$PRETERMBIRTH_LT37 == 1,
  "Birth Asphyxia" = data.static$ASPHYXIA_IND == 1,
  "Stillbirth" = data.static$STILLBIRTH_SIGNS_LIFE == 1,
  "PSBI at IPC" = data.static$INF_PSBI_IPC == 1,
  "Non Severe Jaundice" = data.static$INF_JAUN_NON_SEV_ANY == 1,
  "Maternal Nearmiss" = data.static$NEARMISS== 1
)

# Vector of outcome variables
outcome_vars <- c("STILLBIRTH_SIGNS_LIFE", "INF_ASPH", "INF_PSBI_IPC", "INF_JAUN_NON_SEV_ANY", "PRETERMBIRTH_LT37","NEARMISS")

# Subset relevant columns from data.static
outcome_data <- data.static %>%
  select(PREGID, all_of(outcome_vars))

# Merge into data.temporal.wide by PREGID
data.temporal.wide <- data.temporal.wide %>%
  left_join(outcome_data, by = "PREGID")

#table format
tb_theme1 <- function(matrix){
  tb <- matrix %>%
    gt(
      rownames_to_stub = TRUE
    ) %>%
    opt_align_table_header(align = "left") %>%
    tab_spanner(
      label = "Sites"
    ) %>%
    opt_stylize(style = 6, color = 'gray') %>%
    tab_style(
      style = list(
        cell_fill(color = "#540B0E"),
        cell_text(weight = "bold"),
        cell_text(v_align = "middle"),
        cell_text(color = "white", size = px(18))
      ),
      locations = list(
        cells_title()
      ) 
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#E09F3E"), # #f0b7b3,#f7cbc8, 
        cell_text( color = "black", size = px(18)),
        cell_text(v_align = "middle")
      ),
      locations = list(
        cells_stubhead(),
        cells_column_spanners(),
        cells_column_labels()
      )
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#F0F0F0"),
        cell_text(v_align = "middle", size = px(18))
      ),
      locations = list(
        cells_stub()
      )
    ) %>%
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18))
      ),
      locations = list(
        cells_column_labels(columns = everything())
      )
    ) %>%
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18))
      ),
      locations = list(
        cells_body(columns = everything())
      )
    ) %>%
    fmt_markdown(columns = everything()) %>%
    tab_options(table.width = pct(100)) %>%
    cols_width(1 ~ px(225))
}

n_pct <- function(data, var) {
  denom <- sum(!is.na(data[[var]]))
  numer <- sum(data[[var]] == 1, na.rm = TRUE)
  pct <- ifelse(denom > 0, format(numer / denom * 100, digits = 1, nsmall = 0), "NA")
  paste0(numer, " (", pct, ")")
}

mean_sd <- function(data, var) {
  values <- data[[var]]
  if (all(is.na(values))) return("NA")
  paste0(
    round(mean(values, na.rm = TRUE), 1), " (", 
    format(sd(values, na.rm = TRUE), digits = 1, nsmall = 0), ")"
  )
}
```
\setcounter{tocdepth}{6}
\tableofcontents

\newpage
# 1. Outcome Variables
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),
    "Birth asphyxia: n (%)" = 
      paste0(sum(INF_ASPH == 1, na.rm = TRUE), 
             " (", format(sum(INF_ASPH == 1, na.rm = TRUE)/sum(!is.na(INF_ASPH))*100, digits = 1, nsmall = 0), ")"),

    "Stillbirth: n (%)" = 
      paste0(sum(STILLBIRTH_SIGNS_LIFE == 1, na.rm = TRUE), 
             " (", format(sum(STILLBIRTH_SIGNS_LIFE == 1, na.rm = TRUE)/sum(!is.na(STILLBIRTH_SIGNS_LIFE))*100, digits = 1, nsmall = 0), ")"),

    "Preterm birth (37 weeks): n (%)" = 
      paste0(sum(PRETERMBIRTH_LT37 == 1, na.rm = TRUE), 
             " (", format(sum(PRETERMBIRTH_LT37 == 1, na.rm = TRUE)/sum(!is.na(PRETERMBIRTH_LT37))*100, digits = 1, nsmall = 0), ")"),

    "PSBI at IPC: n (%)" = 
      paste0(sum(INF_PSBI_IPC == 1, na.rm = TRUE), 
             " (", format(sum(INF_PSBI_IPC == 1, na.rm = TRUE)/sum(!is.na(INF_PSBI_IPC))*100, digits = 1, nsmall = 0), ")"),

    "Non-severe Jaundice: n (%)" = 
      paste0(sum(INF_JAUN_NON_SEV_ANY == 1, na.rm = TRUE), 
             " (", format(sum(INF_JAUN_NON_SEV_ANY == 1, na.rm = TRUE)/sum(!is.na(INF_JAUN_NON_SEV_ANY))*100, digits = 1, nsmall = 0), ")"),

    "Maternal Nearmiss: n (%)" = 
      paste0(sum(NEARMISS == 1, na.rm = TRUE), 
             " (", format(sum(NEARMISS == 1, na.rm = TRUE)/sum(!is.na(NEARMISS))*100, digits = 1, nsmall = 0), ")"),
  ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.static %>% 
      summarise(
"Expected denominator, n^a^" = n(),

    "Birth asphyxia: n (%)" = 
      paste0(sum(INF_ASPH == 1, na.rm = TRUE), 
             " (", format(sum(INF_ASPH == 1, na.rm = TRUE)/sum(!is.na(INF_ASPH))*100, digits = 1, nsmall = 0), ")"),

    "Stillbirth: n (%)" = 
      paste0(sum(STILLBIRTH_SIGNS_LIFE == 1, na.rm = TRUE), 
             " (", format(sum(STILLBIRTH_SIGNS_LIFE == 1, na.rm = TRUE)/sum(!is.na(STILLBIRTH_SIGNS_LIFE))*100, digits = 1, nsmall = 0), ")"),

    "Preterm birth (37 weeks): n (%)" = 
      paste0(sum(PRETERMBIRTH_LT37 == 1, na.rm = TRUE), 
             " (", format(sum(PRETERMBIRTH_LT37 == 1, na.rm = TRUE)/sum(!is.na(PRETERMBIRTH_LT37))*100, digits = 1, nsmall = 0), ")"),

    "PSBI at IPC: n (%)" = 
      paste0(sum(INF_PSBI_IPC == 1, na.rm = TRUE), 
             " (", format(sum(INF_PSBI_IPC == 1, na.rm = TRUE)/sum(!is.na(INF_PSBI_IPC))*100, digits = 1, nsmall = 0), ")"),

    "Non-severe Jaundice: n (%)" = 
      paste0(sum(INF_JAUN_NON_SEV_ANY == 1, na.rm = TRUE), 
             " (", format(sum(INF_JAUN_NON_SEV_ANY == 1, na.rm = TRUE)/sum(!is.na(INF_JAUN_NON_SEV_ANY))*100, digits = 1, nsmall = 0), ")"),

    "Maternal Nearmiss: n (%)" = 
      paste0(sum(NEARMISS == 1, na.rm = TRUE), 
             " (", format(sum(NEARMISS == 1, na.rm = TRUE)/sum(!is.na(NEARMISS))*100, digits = 1, nsmall = 0), ")"),
      ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 1: Outcome Variable**")
  ) %>% 
  tab_row_group(
    label = "Neonatal Outcomes",
    rows = 2:6  
  ) %>% 
  tab_row_group(
    label = "Maternal Outcomes",
    rows = 7 
  ) %>%
  row_group_order(groups = c(NA, 
    "Neonatal Outcomes", 
    "Maternal Outcomes"
  )) %>% 
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort; observed denominator are those with non-missing results.")
  )  %>%
  gtsave("Outcome_summary.png", expand = 10)

knitr::include_graphics("Outcome_summary.png")
```
# 2. Risk factors
## 2.1 Demographics and Socioeconomic Characteristics
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),

    # Age
    "Age: mean (SD)" = 
      paste0(round(mean(MAT_AGE, na.rm = TRUE), digits = 1), 
             " (", format(sd(MAT_AGE, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
    # BMI at enrollment
    "BMI at enrollment: mean (SD)" = 
      paste0(round(mean(BMI_ENROLL, na.rm = TRUE), digits = 1), 
             " (", format(sd(BMI_ENROLL, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
    # Mid‐Upper Arm Circumference (MUAC)
    "MUAC: mean (SD)" = 
      paste0(round(mean(MUAC_ENROLL, na.rm = TRUE), digits = 1), 
             " (", format(sd(MUAC_ENROLL, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
    # Crowding Index
    "Crowding Index: mean (SD)" = 
      paste0(round(mean(CROWDING_IND, na.rm = TRUE), digits = 1), 
             " (", format(sd(CROWDING_IND, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
    # Employment
    "Has paid work: n (%)" = 
      paste0(sum(PAID_WORK == 1, na.rm = TRUE), 
             " (", format(sum(PAID_WORK == 1, na.rm = TRUE)/sum(!is.na(PAID_WORK))*100, digits = 1, nsmall = 0), ")"),

    # Parity
    "Parity status 0: n (%)" = 
      paste0(sum(PARITY_0 == 1, na.rm = TRUE), 
             " (", format(sum(PARITY_0 == 1, na.rm = TRUE)/sum(!is.na(PARITY_0))*100, digits = 1, nsmall = 0), ")"),

    "Parity status 1: n (%)" = 
      paste0(sum(PARITY_1 == 1, na.rm = TRUE), 
             " (", format(sum(PARITY_1 == 1, na.rm = TRUE)/sum(!is.na(PARITY_1))*100, digits = 1, nsmall = 0), ")"),

    "Parity status 2+: n (%)" = 
      paste0(sum(PARITY_2 == 1, na.rm = TRUE), 
             " (", format(sum(PARITY_2 == 1, na.rm = TRUE)/sum(!is.na(PARITY_2))*100, digits = 1, nsmall = 0), ")"),

    # Wealth Quintiles
    "Wealth quintile 1: n (%)" = 
      paste0(sum(WEALTH_QUINT_1 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_1 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_1))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 2: n (%)" = 
      paste0(sum(WEALTH_QUINT_2 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_2 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_2))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 3: n (%)" = 
      paste0(sum(WEALTH_QUINT_3 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_3 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_3))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 4: n (%)" = 
      paste0(sum(WEALTH_QUINT_4 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_4 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_4))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 5: n (%)" = 
      paste0(sum(WEALTH_QUINT_5 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_5 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_5))*100, digits = 1, nsmall = 0), ")")
     ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.static %>% 
      summarise(
"Expected denominator, n^a^" = n(),

    # Age
    "Age: mean (SD)" = 
      paste0(round(mean(MAT_AGE, na.rm = TRUE), digits = 1), 
             " (", format(sd(MAT_AGE, na.rm = TRUE), digits = 1, nsmall = 0), ")"),

    # BMI at enrollment
    "BMI at enrollment: mean (SD)" = 
      paste0(round(mean(BMI_ENROLL, na.rm = TRUE), digits = 1), 
             " (", format(sd(BMI_ENROLL, na.rm = TRUE), digits = 1, nsmall = 0), ")"),

    # Mid‐Upper Arm Circumference (MUAC)
    "MUAC: mean (SD)" = 
      paste0(round(mean(MUAC_ENROLL, na.rm = TRUE), digits = 1), 
             " (", format(sd(MUAC_ENROLL, na.rm = TRUE), digits = 1, nsmall = 0), ")"),

    # Crowding Index
    "Crowding Index: mean (SD)" = 
      paste0(round(mean(CROWDING_IND, na.rm = TRUE), digits = 1), 
             " (", format(sd(CROWDING_IND, na.rm = TRUE), digits = 1, nsmall = 0), ")"),

    # Employment
    "Has paid work: n (%)" = 
      paste0(sum(PAID_WORK == 1, na.rm = TRUE), 
             " (", format(sum(PAID_WORK == 1, na.rm = TRUE)/sum(!is.na(PAID_WORK))*100, digits = 1, nsmall = 0), ")"),

    # Parity
    "Parity status 0: n (%)" = 
      paste0(sum(PARITY_0 == 1, na.rm = TRUE), 
             " (", format(sum(PARITY_0 == 1, na.rm = TRUE)/sum(!is.na(PARITY_0))*100, digits = 1, nsmall = 0), ")"),

    "Parity status 1: n (%)" = 
      paste0(sum(PARITY_1 == 1, na.rm = TRUE), 
             " (", format(sum(PARITY_1 == 1, na.rm = TRUE)/sum(!is.na(PARITY_1))*100, digits = 1, nsmall = 0), ")"),

    "Parity status 2+: n (%)" = 
      paste0(sum(PARITY_2 == 1, na.rm = TRUE), 
             " (", format(sum(PARITY_2 == 1, na.rm = TRUE)/sum(!is.na(PARITY_2))*100, digits = 1, nsmall = 0), ")"),

    # Wealth Quintiles
    "Wealth quintile 1: n (%)" = 
      paste0(sum(WEALTH_QUINT_1 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_1 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_1))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 2: n (%)" = 
      paste0(sum(WEALTH_QUINT_2 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_2 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_2))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 3: n (%)" = 
      paste0(sum(WEALTH_QUINT_3 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_3 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_3))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 4: n (%)" = 
      paste0(sum(WEALTH_QUINT_4 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_4 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_4))*100, digits = 1, nsmall = 0), ")"),

    "Wealth quintile 5: n (%)" = 
      paste0(sum(WEALTH_QUINT_5 == 1, na.rm = TRUE), 
             " (", format(sum(WEALTH_QUINT_5 == 1, na.rm = TRUE)/sum(!is.na(WEALTH_QUINT_5))*100, digits = 1, nsmall = 0), ")"),

      ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 2.1.1: Demographics and Socioeconomic Characteristics by Site**")
  ) %>% 

  # Grouping Rows for Sections
  tab_row_group(
    label = "Maternal Age",
    rows = 2  
  ) %>% 
  tab_row_group(
    label = "BMI at enrollment",
    rows = 3 
  ) %>% 
  tab_row_group(
    label = "Mid-Upper Arm Circumference (MUAC)",
    rows = 4  
  ) %>% 
  tab_row_group(
    label = "Crowding Index",
    rows = 5  
  ) %>%
  tab_row_group(
    label = "Employment",
    rows = 6 
  ) %>% 
  tab_row_group(
    label = "Parity Status",
    rows = 7:9  
  ) %>% 
  tab_row_group(
    label = "Wealth Quintiles",
    rows = 10:14  
  )  %>% 
  
  row_group_order(groups = c(NA, 
    "Maternal Age", 
    "BMI at enrollment", 
    "Mid-Upper Arm Circumference (MUAC)", 
    "Crowding Index",
    "Employment", 
    "Parity Status", 
    "Wealth Quintiles"
  )) %>% 
  
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort; observed denominator includes those with non-missing results.")
  ) %>%
  
  gtsave("Demographic_Socioeconomic_Summary.png", expand = 10)

knitr::include_graphics("Demographic_Socioeconomic_Summary.png")

```
```{r}
# Define variables
vars_cont <- c(
  "MAT_AGE" = "Age: mean (SD)",
  "BMI_ENROLL" = "BMI at enrollment: mean (SD)",
  "MUAC_ENROLL" = "MUAC: mean (SD)",
  "CROWDING_IND" = "Crowding Index: mean (SD)"
)

vars_cat <- c(
  "PAID_WORK" = "Has paid work: n (%)",
  "PARITY_0" = "Parity status 0: n (%)",
  "PARITY_1" = "Parity status 1: n (%)",
  "PARITY_2" = "Parity status 2+: n (%)",
  "WEALTH_QUINT_1" = "Wealth quintile 1: n (%)",
  "WEALTH_QUINT_2" = "Wealth quintile 2: n (%)",
  "WEALTH_QUINT_3" = "Wealth quintile 3: n (%)",
  "WEALTH_QUINT_4" = "Wealth quintile 4: n (%)",
  "WEALTH_QUINT_5" = "Wealth quintile 5: n (%)"
)

# Combine into matrix
matrix_demo_a <- tibble(Covariates = c(vars_cont, vars_cat))

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- c(
    sapply(names(vars_cont), function(v) mean_sd(data.static[outcome_filters[[label]], ], v)),
    sapply(names(vars_cat), function(v) n_pct(data.static[outcome_filters[[label]], ], v))
  )
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")
for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Combine and convert
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Build gt table
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.1.2: Demographic and Socioeconomic Characteristics by Outcomes**")) %>%

  tab_row_group(label = "Maternal Age", rows = "Age: mean (SD)") %>%
  tab_row_group(label = "BMI at enrollment", rows = "BMI at enrollment: mean (SD)") %>%
  tab_row_group(label = "Mid-Upper Arm Circumference (MUAC)", rows = "MUAC: mean (SD)") %>%
  tab_row_group(label = "Crowding Index", rows = "Crowding Index: mean (SD)") %>%
  tab_row_group(label = "Employment", rows = "Has paid work: n (%)") %>%
  tab_row_group(label = "Parity Status", rows = c(
    "Parity status 0: n (%)", "Parity status 1: n (%)", "Parity status 2+: n (%)"
  )) %>%
  tab_row_group(label = "Wealth Quintiles", rows = c(
    "Wealth quintile 1: n (%)", "Wealth quintile 2: n (%)", 
    "Wealth quintile 3: n (%)", "Wealth quintile 4: n (%)", 
    "Wealth quintile 5: n (%)"
  )) %>%
  row_group_order(c(NA, "Maternal Age", "BMI at enrollment", "Mid-Upper Arm Circumference (MUAC)","Crowding Index","Employment", "Parity Status", "Wealth Quintiles")) %>%

  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort")
  ) %>%
  gtsave("Demographic_Socioeconomic_Outcome.png", expand = 10)

# Show in RMarkdown
knitr::include_graphics("Demographic_Socioeconomic_Outcome.png")

```
## 2.2 Air & Water Pollution
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),
 # Household Characteristics
    "Use of improved water: n (%)" = 
      paste0(sum(WATER_IMPROVED == 1, na.rm = TRUE), 
             " (", format(sum(WATER_IMPROVED == 1, na.rm = TRUE)/sum(!is.na(WATER_IMPROVED))*100, digits = 1, nsmall = 0), ")"),

    "Use of improved toilet: n (%)" = 
      paste0(sum(TOILET_IMPROVED == 1, na.rm = TRUE), 
             " (", format(sum(TOILET_IMPROVED == 1, na.rm = TRUE)/sum(!is.na(TOILET_IMPROVED))*100, digits = 1, nsmall = 0), ")"),

    "Use of unclean cooking fuel: n (%)" = 
      paste0(sum(STOVE_FUEL == 1, na.rm = TRUE), 
             " (", format(sum(STOVE_FUEL == 1, na.rm = TRUE)/sum(!is.na(STOVE_FUEL))*100, digits = 1, nsmall = 0), ")"),

    "Smoking inside the house: n (%)" = 
      paste0(sum(HH_SMOKE == 1, na.rm = TRUE), 
             " (", format(sum(HH_SMOKE == 1, na.rm = TRUE)/sum(!is.na(HH_SMOKE))*100, digits = 1, nsmall = 0), ")"),
     "Smoking: n (%)" = 
       paste0(sum(SMOKE == 1, na.rm = TRUE), 
         " (", format(sum(SMOKE == 1, na.rm = TRUE)/sum(!is.na(SMOKE))*100, digits = 1, nsmall = 0), ")"),
      "Chewing tobacco use: n (%)" = 
      paste0(sum(CHEW_TOBACCO == 1, na.rm = TRUE), 
         " (", format(sum(CHEW_TOBACCO == 1, na.rm = TRUE)/sum(!is.na(CHEW_TOBACCO))*100, digits = 1, nsmall = 0), ")"),
      "Chewing betel nut use: n (%)" = 
      paste0(sum(CHEW_BETELNUT == 1, na.rm = TRUE), 
         " (", format(sum(CHEW_BETELNUT == 1, na.rm = TRUE)/sum(!is.na(CHEW_BETELNUT))*100, digits = 1, nsmall = 0), ")"),
     ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.static %>% 
      summarise(
"Expected denominator, n^a^" = n(),
 # Household Characteristics
    "Use of improved water: n (%)" = 
      paste0(sum(WATER_IMPROVED == 1, na.rm = TRUE), 
             " (", format(sum(WATER_IMPROVED == 1, na.rm = TRUE)/sum(!is.na(WATER_IMPROVED))*100, digits = 1, nsmall = 0), ")"),
    "Use of improved toilet: n (%)" = 
      paste0(sum(TOILET_IMPROVED == 1, na.rm = TRUE), 
             " (", format(sum(TOILET_IMPROVED == 1, na.rm = TRUE)/sum(!is.na(TOILET_IMPROVED))*100, digits = 1, nsmall = 0), ")"),
    "Use of unclean cooking fuel: n (%)" = 
      paste0(sum(STOVE_FUEL == 1, na.rm = TRUE), 
             " (", format(sum(STOVE_FUEL == 1, na.rm = TRUE)/sum(!is.na(STOVE_FUEL))*100, digits = 1, nsmall = 0), ")"),
    "Smoking inside the house: n (%)" = 
      paste0(sum(HH_SMOKE == 1, na.rm = TRUE), 
             " (", format(sum(HH_SMOKE == 1, na.rm = TRUE)/sum(!is.na(HH_SMOKE))*100, digits = 1, nsmall = 0), ")"),
     "Smoking: n (%)" = 
       paste0(sum(SMOKE == 1, na.rm = TRUE), 
         " (", format(sum(SMOKE == 1, na.rm = TRUE)/sum(!is.na(SMOKE))*100, digits = 1, nsmall = 0), ")"),
      "Chewing tobacco use: n (%)" = 
      paste0(sum(CHEW_TOBACCO == 1, na.rm = TRUE), 
         " (", format(sum(CHEW_TOBACCO == 1, na.rm = TRUE)/sum(!is.na(CHEW_TOBACCO))*100, digits = 1, nsmall = 0), ")"),
      "Chewing betel nut use: n (%)" = 
      paste0(sum(CHEW_BETELNUT == 1, na.rm = TRUE), 
         " (", format(sum(CHEW_BETELNUT == 1, na.rm = TRUE)/sum(!is.na(CHEW_BETELNUT))*100, digits = 1, nsmall = 0), ")"),      ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 2.2.1: Summary of Environmental Exposures by Site**")
  ) %>% 
 tab_row_group(
    label = "Water & Sanitation",
    rows = 2:3 
  )  %>% 
   tab_row_group(
    label = "Air Pollution",
    rows = 4:5  
  )  %>% 
   tab_row_group(
    label = "Tobacco Exposure",
    rows = 6:8  
  )  %>% 
  row_group_order(groups = c(NA,
    "Water & Sanitation","Air Pollution","Tobacco Exposure"
  )) %>% 
  
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is the PRiSMA cohort; observed denominator includes those with non-missing results.")
  ) %>%
  
  gtsave("Pollution_Summary.png", expand = 10)

knitr::include_graphics("Pollution_Summary.png")

```
```{r}
# Define variables and labels
vars <- c(
  "WATER_IMPROVED"   = "Use of improved water: n (%)",
  "TOILET_IMPROVED"  = "Use of improved toilet: n (%)",
  "STOVE_FUEL"       = "Use of unclean cooking fuel: n (%)",
  "HH_SMOKE"         = "Smoking inside the house: n (%)",
  "SMOKE"            = "Smoking: n (%)",
  "CHEW_TOBACCO"     = "Chewing tobacco use: n (%)",
  "CHEW_BETELNUT"    = "Chewing betel nut use: n (%)"
)

# Build summary matrix
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.static[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")

for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Final data for gt
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Render table
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.2.2: Summary of Environmental Exposures by Outcomes**")) %>%

  # Row groups
  tab_row_group(label = "Water & Sanitation", rows = c(
    "Use of improved water: n (%)", "Use of improved toilet: n (%)"
  )) %>%
  tab_row_group(label = "Air Pollution", rows = c(
    "Use of unclean cooking fuel: n (%)", "Smoking inside the house: n (%)"
  )) %>%
  tab_row_group(label = "Tobacco Exposure", rows = c(
    "Smoking: n (%)", "Chewing tobacco use: n (%)", "Chewing betel nut use: n (%)"
  )) %>%
  row_group_order(c(NA, "Water & Sanitation", "Air Pollution", "Tobacco Exposure")) %>%

  # Footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort")
  ) %>%
  gtsave("Environmental_Exposure_Outcome.png", expand = 10)

knitr::include_graphics("Environmental_Exposure_Outcome.png")

```
## 2.3 Obstetric History
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),
    "Stillbirth: n (%)" = 
      paste0(sum(STILLBIRTH_IND == 1, na.rm = TRUE), 
             " (", format(sum(STILLBIRTH_IND == 1, na.rm = TRUE)/sum(!is.na(STILLBIRTH_IND))*100, digits = 1, nsmall = 0), ")"),
    "Preterm birth: n (%)" = 
      paste0(sum(PRETERM_IND == 1, na.rm = TRUE), 
             " (", format(sum(PRETERM_IND == 1, na.rm = TRUE)/sum(!is.na(PRETERM_IND))*100, digits = 1, nsmall = 0), ")"),
    "Miscarriage: n (%)" = 
      paste0(sum(MISCARRIAGE == 1, na.rm = TRUE), 
             " (", format(sum(MISCARRIAGE == 1, na.rm = TRUE)/sum(!is.na(MISCARRIAGE))*100, digits = 1, nsmall = 0), ")"),
    "C-section: n (%)" = 
      paste0(sum(CESARIAN_IND == 1, na.rm = TRUE), 
             " (", format(sum(CESARIAN_IND == 1, na.rm = TRUE)/sum(!is.na(CESARIAN_IND))*100, digits = 1, nsmall = 0), ")"),
  ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.static %>% 
      summarise(
"Expected denominator, n^a^" = n(),
    "Stillbirth: n (%)" = 
      paste0(sum(STILLBIRTH_IND == 1, na.rm = TRUE), 
             " (", format(sum(STILLBIRTH_IND == 1, na.rm = TRUE)/sum(!is.na(STILLBIRTH_IND))*100, digits = 1, nsmall = 0), ")"),
    "Preterm birth: n (%)" = 
      paste0(sum(PRETERM_IND == 1, na.rm = TRUE), 
             " (", format(sum(PRETERM_IND == 1, na.rm = TRUE)/sum(!is.na(PRETERM_IND))*100, digits = 1, nsmall = 0), ")"),
    "Miscarriage: n (%)" = 
      paste0(sum(MISCARRIAGE == 1, na.rm = TRUE), 
             " (", format(sum(MISCARRIAGE == 1, na.rm = TRUE)/sum(!is.na(MISCARRIAGE))*100, digits = 1, nsmall = 0), ")"),
    "C-section: n (%)" = 
      paste0(sum(CESARIAN_IND == 1, na.rm = TRUE), 
             " (", format(sum(CESARIAN_IND == 1, na.rm = TRUE)/sum(!is.na(CESARIAN_IND))*100, digits = 1, nsmall = 0), ")"),
      ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 2.3.1: Summary of Obstetric History by Site**")
  ) %>% 
  tab_row_group(
    label = "Stillbirth",
    rows = 2  
  ) %>% tab_row_group(
    label = "Preterm birth",
    rows = 3 
  ) %>% 
  tab_row_group(
    label = "Miscarriage",
    rows = 4  
  ) %>%   tab_row_group(
    label = "C-section",
    rows = 5  
  ) %>%   
  row_group_order(groups = c(NA, 
    "Stillbirth", 
    "Preterm birth", 
    "Miscarriage",
    "C-section"
  )) %>% 
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort; observed denominator are those with non-missing results.")
  )  %>%
  gtsave("Obstetric_History_Summary.png", expand = 10)

knitr::include_graphics("Obstetric_History_Summary.png")
```
```{r}
vars <- c(
  "STILLBIRTH_IND" = "Stillbirth: n (%)",
  "PRETERM_IND" = "Preterm birth: n (%)",
  "MISCARRIAGE" = "Miscarriage: n (%)",
  "CESARIAN_IND" = "C-section: n (%)"
)

# Generate summary matrix
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.static[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")

for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Final table
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Create gt table
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.3.2: Summary of Obstetric History by outcomes**")) %>%

  # Group rows
  tab_row_group(label = "Stillbirth", rows = "Stillbirth: n (%)") %>%
  tab_row_group(label = "Preterm birth", rows = "Preterm birth: n (%)") %>%
  tab_row_group(label = "Miscarriage", rows = "Miscarriage: n (%)") %>%
  tab_row_group(label = "C-section", rows = "C-section: n (%)") %>%
  row_group_order(c(NA, "Stillbirth", "Preterm birth", "Miscarriage", "C-section")) %>%

  # Footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort")
  ) %>% gtsave("Obstetric_History_Outcome.png", expand = 10)

knitr::include_graphics("Obstetric_History_Outcome.png")

```
## 2.4 Pre-existing Co-morbids
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
    "Expected denominator, n^a^" = n(),

    # HTN
    "Positive for HTN: n (%)" = paste0(
      sum(HTN_ANY == 1, na.rm = TRUE), " (", 
      format(sum(HTN_ANY == 1, na.rm = TRUE) / sum(!is.na(HTN_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    # Diabetes
    "Positive for Diabetes: n (%)" = paste0(
      sum(DIAB_OVERT_ANY == 1, na.rm = TRUE), " (", 
      format(sum(DIAB_OVERT_ANY == 1, na.rm = TRUE) / sum(!is.na(DIAB_OVERT_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    # HIV
    "Positive for HIV: n (%)" = paste0(
      sum(HIV_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
      format(sum(HIV_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(HIV_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")"),

    # TB
    "Positive for TB: n (%)" = paste0(
      sum(TB_SYMP_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
      format(sum(TB_SYMP_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(TB_SYMP_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")"),

    # Malaria
    "Positive for Malaria: n (%)" = paste0(
      sum(MAL_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
      format(sum(MAL_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(MAL_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")"),

    # STIs
    "Positive for STIs: n (%)" = paste0(
      sum(STI_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
      format(sum(STI_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(STI_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")")
  ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(.[1,]) %>% 
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = data.static %>% 
      summarise(
        "Expected denominator, n^a^" = n(),

        "Positive for HTN: n (%)" = paste0(
          sum(HTN_ANY == 1, na.rm = TRUE), " (", 
          format(sum(HTN_ANY == 1, na.rm = TRUE) / sum(!is.na(HTN_ANY)) * 100, digits = 1, nsmall = 0), ")"),

        "Positive for Diabetes: n (%)" = paste0(
          sum(DIAB_OVERT_ANY == 1, na.rm = TRUE), " (", 
          format(sum(DIAB_OVERT_ANY == 1, na.rm = TRUE) / sum(!is.na(DIAB_OVERT_ANY)) * 100, digits = 1, nsmall = 0), ")"),

        "Positive for HIV: n (%)" = paste0(
          sum(HIV_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
          format(sum(HIV_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(HIV_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")"),

        "Positive for TB: n (%)" = paste0(
          sum(TB_SYMP_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
          format(sum(TB_SYMP_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(TB_SYMP_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")"),

        "Positive for Malaria: n (%)" = paste0(
          sum(MAL_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
          format(sum(MAL_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(MAL_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")"),

        "Positive for STIs: n (%)" = paste0(
          sum(STI_POSITIVE_ENROLL == 1, na.rm = TRUE), " (", 
          format(sum(STI_POSITIVE_ENROLL == 1, na.rm = TRUE) / sum(!is.na(STI_POSITIVE_ENROLL)) * 100, digits = 1, nsmall = 0), ")")
      ) %>%
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(title = md("**Table 2.4.1: Summary of Pre-existing Co-morbids by Site**")) %>% 
  
  # Group rows
  tab_row_group(label = "Hypertensive disorders", rows = 2) %>% 
  tab_row_group(label = "Metabolic disorders", rows = 3) %>% 
  tab_row_group(label = "Infectious diseases", rows = 4:7) %>% 
  # Row group order
  row_group_order(c(NA, "Hypertensive disorders", "Metabolic disorders", "Infectious diseases")) %>%
  
  # Optional footnotes
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort; observed denominator are those with non-missing results.")
  ) %>%
  tab_footnote(
    footnote = html("All variables measured at enrollment.")
  ) %>% gtsave("Pre-existing_Co-morbids_Summary.png", expand = 10)

knitr::include_graphics("Pre-existing_Co-morbids_Summary.png")
```
```{r}
# Variables to summarize
vars <- c(
  "HTN_ANY" = "HTN: n (%)",
  "DIAB_OVERT_ANY" = "Diabetes: n (%)",
  "HIV_POSITIVE_ENROLL" = "HIV: n (%)",
  "TB_SYMP_POSITIVE_ENROLL" = "TB: n (%)",
  "MAL_POSITIVE_ENROLL" = "Malaria: n (%)",
  "STI_POSITIVE_ENROLL" = "STIs: n (%)"
)

# Build table
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.static[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")

for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Bind and convert for gt
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Format with gt
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.4.2: Summary of Pre-existing Co-Morbids by Outcomes**")) %>%

  # Group rows
  tab_row_group(label = "Hypertensive disorders", rows = "HTN: n (%)") %>%
  tab_row_group(label = "Metabolic disorders", rows = "Diabetes: n (%)") %>%
  tab_row_group(label = "Infectious diseases", rows = c(
    "HIV: n (%)", "TB: n (%)", "Malaria: n (%)", "STIs: n (%)"
  )) %>%
  row_group_order(c(NA, "Hypertensive disorders", "Metabolic disorders", "Infectious diseases")) %>%

  # Footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort")
  ) %>% gtsave("Pre-existing_Co-morbids_Outcome.png", expand = 10)
knitr::include_graphics("Pre-existing_Co-morbids_Outcome.png")

```
## 2.5 Current Co-morbids
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
    "Expected denominator, n^a^" = n(),

    # GHTN
    "Positive for Gestational HTN: n (%)" = paste0(
      sum(GHTN == 1, na.rm = TRUE), " (",
      format(sum(GHTN == 1, na.rm = TRUE) / sum(!is.na(GHTN)) * 100, digits = 1, nsmall = 0), ")"),

    # GDM
    "Positive for GDM: n (%)" = paste0(
      sum(DIAB_GEST_ANY == 1, na.rm = TRUE), " (",
      format(sum(DIAB_GEST_ANY == 1, na.rm = TRUE) / sum(!is.na(DIAB_GEST_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    # HIV
    "Positive for HIV: n (%)" = paste0(
      sum(HIV_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
      format(sum(HIV_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(HIV_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),

    # TB
    "Positive for TB: n (%)" = paste0(
      sum(TB_SYMP_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
      format(sum(TB_SYMP_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(TB_SYMP_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),

    # Malaria
    "Positive for Malaria: n (%)" = paste0(
      sum(MAL_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
      format(sum(MAL_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(MAL_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),

    # Hep B
    "Positive for Heb B: n (%)" = paste0(
      sum(HBV_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
      format(sum(HBV_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(HBV_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),

    # Hep C
    "Positive for Heb C: n (%)" = paste0(
      sum(HCV_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
      format(sum(HCV_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(HCV_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),

    # STIs
    "Positive for STIs: n (%)" = paste0(
      sum(STI_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
      format(sum(STI_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(STI_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")")
  ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(.[1,]) %>% 
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = data.static %>% summarise(
      "Expected denominator, n^a^" = n(),
      "Positive for Gestational HTN: n (%)" = paste0(
        sum(GHTN == 1, na.rm = TRUE), " (",
        format(sum(GHTN == 1, na.rm = TRUE) / sum(!is.na(GHTN)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for GDM: n (%)" = paste0(
        sum(DIAB_GEST_ANY == 1, na.rm = TRUE), " (",
        format(sum(DIAB_GEST_ANY == 1, na.rm = TRUE) / sum(!is.na(DIAB_GEST_ANY)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for HIV: n (%)" = paste0(
        sum(HIV_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
        format(sum(HIV_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(HIV_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for TB: n (%)" = paste0(
        sum(TB_SYMP_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
        format(sum(TB_SYMP_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(TB_SYMP_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for Malaria: n (%)" = paste0(
        sum(MAL_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
        format(sum(MAL_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(MAL_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for Heb B: n (%)" = paste0(
        sum(HBV_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
        format(sum(HBV_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(HBV_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for Heb C: n (%)" = paste0(
        sum(HCV_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
        format(sum(HCV_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(HCV_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")"),
      "Positive for STIs: n (%)" = paste0(
        sum(STI_POSITIVE_ANY_ANC == 1, na.rm = TRUE), " (",
        format(sum(STI_POSITIVE_ANY_ANC == 1, na.rm = TRUE) / sum(!is.na(STI_POSITIVE_ANY_ANC)) * 100, digits = 1, nsmall = 0), ")")
    ) %>% t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(title = md("**Table 2.5.1: Summary of Current Co-morbids by Site**")) %>%
  
  # Add row groups
  tab_row_group(label = "Hypertensive disorders", rows = 2) %>%
  tab_row_group(label = "Metabolic disorders",rows = 3) %>%
  tab_row_group(label = "Infectious diseases",rows = 4:9) %>%
  # Control row group order
  row_group_order(c(
    NA, "Hypertensive disorders", "Metabolic disorders", "Infectious diseases"
  )) %>%
  # Add footnotes
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is full PRiSMA cohort; observed denominator reflects available data.")
  ) %>% gtsave("Current_Co_morbids_Summary.png", expand = 10)

knitr::include_graphics("Current_Co_morbids_Summary.png")
```
```{r}
# Define variables and labels
vars <- c(
  "GHTN" = "Gestational HTN: n (%)",
  "DIAB_GEST_ANY" = "GDM: n (%)",
  "HIV_POSITIVE_ANY_ANC" = "HIV: n (%)",
  "TB_SYMP_POSITIVE_ANY_ANC" = "TB: n (%)",
  "MAL_POSITIVE_ANY_ANC" = "Malaria: n (%)",
  "HBV_POSITIVE_ANY_ANC" = "Hep B: n (%)",
  "HCV_POSITIVE_ANY_ANC" = "Hep C: n (%)",
  "STI_POSITIVE_ANY_ANC" = "STIs: n (%)"
)


# Construct summary table
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.static[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")
for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Finalize table structure
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Create gt table
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.5.2: Summary of Current Co-morbids by Outcomes**")) %>%

  # Row groups
  tab_row_group(label = "Hypertensive disorders", rows = "Gestational HTN: n (%)") %>%
  tab_row_group(label = "Metabolic disorders",     rows = "GDM: n (%)") %>%
  tab_row_group(label = "Infectious diseases",     rows = c(
    "HIV: n (%)", "TB: n (%)", "Malaria: n (%)", "Hep B: n (%)", "Hep C: n (%)", "STIs: n (%)"
  )) %>%
  row_group_order(c(
    NA, "Hypertensive disorders", "Metabolic disorders", "Infectious diseases"
  )) %>%

  # Footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is full PRiSMA cohort")
  ) %>%
  gtsave("Current_Co_morbids_Outcome.png", expand = 10)

# Display image in Rmd
knitr::include_graphics("Current_Co_morbids_Outcome.png")

```
## 2.6 Pregnancy & Labor
```{r}
matrix_demo_a <- data.static %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),

    # Fetal Presentation
    "Cephalic: n (%)" = 
      paste0(sum(INF_PRES_CEPH == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_CEPH == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_CEPH)) * 100, digits = 1, nsmall = 0), ")"),
    "Breech: n (%)" = 
      paste0(sum(INF_PRES_BREECH == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_BREECH == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_BREECH)) * 100, digits = 1, nsmall = 0), ")"),

    "Transverse lie: n (%)" = 
      paste0(sum(INF_PRES_TRANS == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_TRANS == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_TRANS)) * 100, digits = 1, nsmall = 0), ")"),

    "Brow or face: n (%)" = 
      paste0(sum(INF_PRES_BROW == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_BROW == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_BROW)) * 100, digits = 1, nsmall = 0), ")"),

    "Other: n (%)" = 
      paste0(sum(INF_PRES_OTHER == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_OTHER == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_OTHER)) * 100, digits = 1, nsmall = 0), ")"),

    # Membrane Status
    "Spontaneous: n (%)" = 
      paste0(sum(MEM_SPON == 1, na.rm = TRUE), 
             " (", format(sum(MEM_SPON == 1, na.rm = TRUE) / sum(!is.na(MEM_SPON)) * 100, digits = 1, nsmall = 0), ")"),

    "Artificial: n (%)" = 
      paste0(sum(MEM_ART == 1, na.rm = TRUE), 
             " (", format(sum(MEM_ART == 1, na.rm = TRUE) / sum(!is.na(MEM_ART)) * 100, digits = 1, nsmall = 0), ")"),

    "Not applicable: n (%)" = 
      paste0(sum(MEM_CES == 1, na.rm = TRUE), 
             " (", format(sum(MEM_CES == 1, na.rm = TRUE) / sum(!is.na(MEM_CES)) * 100, digits = 1, nsmall = 0), ")"),

    # Pregnancy Outcome
    "Preterm pregnancy endpoint (<37 weeks): n (%)" = 
      paste0(sum(MAT_PRETERM_ANY == 1, na.rm = TRUE), 
             " (", format(sum(MAT_PRETERM_ANY == 1, na.rm = TRUE) / sum(!is.na(MAT_PRETERM_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    # Labor and Delivery
    "Experienced any labor: n (%)" = 
      paste0(sum(LABOR_ANY == 1, na.rm = TRUE), 
             " (", format(sum(LABOR_ANY == 1, na.rm = TRUE) / sum(!is.na(LABOR_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    "Prolonged labor: n (%)" = 
      paste0(sum(PRO_LABOR == 1, na.rm = TRUE), 
             " (", format(sum(PRO_LABOR == 1, na.rm = TRUE) / sum(!is.na(PRO_LABOR)) * 100, digits = 1, nsmall = 0), ")"),

    "Obstructed labor: n (%)" = 
      paste0(sum(OBS_LABOR == 1, na.rm = TRUE), 
             " (", format(sum(OBS_LABOR == 1, na.rm = TRUE) / sum(!is.na(OBS_LABOR)) * 100, digits = 1, nsmall = 0), ")"),

    # Hemorrhage
    "Antepartum hemorrhage during ANC: n (%)" = 
      paste0(sum(HEM_APH == 1, na.rm = TRUE), 
             " (", format(sum(HEM_APH == 1, na.rm = TRUE) / sum(!is.na(HEM_APH)) * 100, digits = 1, nsmall = 0), ")"),

   # Cesarean delivery
    "Cesarean delivery: n (%)" = 
      paste0(sum(MAT_CES_ANY == 1, na.rm = TRUE), 
             " (", format(sum(MAT_CES_ANY == 1, na.rm = TRUE) / sum(!is.na(MAT_CES_ANY)) * 100, digits = 1, nsmall = 0), ")"),
   # Birth facility
    "Birth at facility: n (%)" = 
      paste0(sum(BIRTH_FACILITY == 1, na.rm = TRUE), 
             " (", format(sum(BIRTH_FACILITY == 1, na.rm = TRUE) / sum(!is.na(BIRTH_FACILITY)) * 100, digits = 1, nsmall = 0), ")")
     ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.static %>% 
      summarise(
"Expected denominator, n^a^" = n(),

    # Fetal Presentation
    "Cephalic: n (%)" = 
      paste0(sum(INF_PRES_CEPH == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_CEPH == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_CEPH)) * 100, digits = 1, nsmall = 0), ")"),
    "Breech: n (%)" = 
      paste0(sum(INF_PRES_BREECH == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_BREECH == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_BREECH)) * 100, digits = 1, nsmall = 0), ")"),

    "Transverse lie: n (%)" = 
      paste0(sum(INF_PRES_TRANS == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_TRANS == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_TRANS)) * 100, digits = 1, nsmall = 0), ")"),

    "Brow or face: n (%)" = 
      paste0(sum(INF_PRES_BROW == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_BROW == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_BROW)) * 100, digits = 1, nsmall = 0), ")"),

    "Other: n (%)" = 
      paste0(sum(INF_PRES_OTHER == 1, na.rm = TRUE), 
             " (", format(sum(INF_PRES_OTHER == 1, na.rm = TRUE) / sum(!is.na(INF_PRES_OTHER)) * 100, digits = 1, nsmall = 0), ")"),

    # Membrane Status
    "Spontaneous: n (%)" = 
      paste0(sum(MEM_SPON == 1, na.rm = TRUE), 
             " (", format(sum(MEM_SPON == 1, na.rm = TRUE) / sum(!is.na(MEM_SPON)) * 100, digits = 1, nsmall = 0), ")"),

    "Artificial: n (%)" = 
      paste0(sum(MEM_ART == 1, na.rm = TRUE), 
             " (", format(sum(MEM_ART == 1, na.rm = TRUE) / sum(!is.na(MEM_ART)) * 100, digits = 1, nsmall = 0), ")"),

    "Not applicable: n (%)" = 
      paste0(sum(MEM_CES == 1, na.rm = TRUE), 
             " (", format(sum(MEM_CES == 1, na.rm = TRUE) / sum(!is.na(MEM_CES)) * 100, digits = 1, nsmall = 0), ")"),

    # Pregnancy Outcome
    "Preterm pregnancy endpoint (<37 weeks): n (%)" = 
      paste0(sum(MAT_PRETERM_ANY == 1, na.rm = TRUE), 
             " (", format(sum(MAT_PRETERM_ANY == 1, na.rm = TRUE) / sum(!is.na(MAT_PRETERM_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    # Labor and Delivery
    "Experienced any labor: n (%)" = 
      paste0(sum(LABOR_ANY == 1, na.rm = TRUE), 
             " (", format(sum(LABOR_ANY == 1, na.rm = TRUE) / sum(!is.na(LABOR_ANY)) * 100, digits = 1, nsmall = 0), ")"),

    "Prolonged labor: n (%)" = 
      paste0(sum(PRO_LABOR == 1, na.rm = TRUE), 
             " (", format(sum(PRO_LABOR == 1, na.rm = TRUE) / sum(!is.na(PRO_LABOR)) * 100, digits = 1, nsmall = 0), ")"),

    "Obstructed labor: n (%)" = 
      paste0(sum(OBS_LABOR == 1, na.rm = TRUE), 
             " (", format(sum(OBS_LABOR == 1, na.rm = TRUE) / sum(!is.na(OBS_LABOR)) * 100, digits = 1, nsmall = 0), ")"),

    # Hemorrhage
    "Antepartum hemorrhage during ANC: n (%)" = 
      paste0(sum(HEM_APH == 1, na.rm = TRUE), 
             " (", format(sum(HEM_APH == 1, na.rm = TRUE) / sum(!is.na(HEM_APH)) * 100, digits = 1, nsmall = 0), ")"),

   # Cesarean delivery
    "Cesarean delivery: n (%)" = 
      paste0(sum(MAT_CES_ANY == 1, na.rm = TRUE), 
             " (", format(sum(MAT_CES_ANY == 1, na.rm = TRUE) / sum(!is.na(MAT_CES_ANY)) * 100, digits = 1, nsmall = 0), ")"),
   # Birth facility
    "Birth at facility: n (%)" = 
      paste0(sum(BIRTH_FACILITY == 1, na.rm = TRUE), 
             " (", format(sum(BIRTH_FACILITY == 1, na.rm = TRUE) / sum(!is.na(BIRTH_FACILITY)) * 100, digits = 1, nsmall = 0), ")")
      ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 2.6.1: Summary of Pregnancy and Labor by Site**")
  ) %>% 

  # Grouping by Pregnancy and Labor Conditions
  tab_row_group(label = "Fetal Presentation", rows = 2:6) %>% 
  tab_row_group(label = "Membrane Status", rows = 7:9) %>% 
  tab_row_group(label = "Pregnancy Outcome", rows = 10) %>% 
  tab_row_group(label = "Labor and Delivery", rows = 11:13) %>% 
  tab_row_group(label = "Hemorrhage", rows = 14) %>% 
  tab_row_group(label = "Cesarean delivery", rows = 15) %>% 
  tab_row_group(label = "Birth facility", rows = 16) %>% 
  row_group_order(groups = c(NA, 
    "Fetal Presentation", 
    "Membrane Status", 
    "Pregnancy Outcome",
    "Labor and Delivery",
    "Hemorrhage",
    "Cesarean delivery",
    "Birth facility"
  )) %>% 

  # Save table as an image
  gtsave("Pregnancy_Labor_Summary.png", expand = 10)

# Display Image in RMarkdown
knitr::include_graphics("Pregnancy_Labor_Summary.png")

```
```{r}
# Define variables to summarize
vars <- c(
  "INF_PRES_CEPH"   = "Cephalic: n (%)",
  "INF_PRES_BREECH" = "Breech: n (%)",
  "INF_PRES_TRANS"  = "Transverse lie: n (%)",
  "INF_PRES_BROW"   = "Brow or face: n (%)",
  "INF_PRES_OTHER"  = "Other: n (%)",
  
  "MEM_SPON" = "Spontaneous: n (%)",
  "MEM_ART"  = "Artificial: n (%)",
  "MEM_CES"  = "Not applicable: n (%)",

  "MAT_PRETERM_ANY" = "Preterm pregnancy endpoint (<37 weeks): n (%)",
  
  "LABOR_ANY"    = "Experienced any labor: n (%)",
  "PRO_LABOR"    = "Prolonged labor: n (%)",
  "OBS_LABOR"    = "Obstructed labor: n (%)",
  
  "HEM_APH"      = "Antepartum hemorrhage during ANC: n (%)",
  "MAT_CES_ANY"  = "Cesarean delivery: n (%)",
  "BIRTH_FACILITY"  = "Birth facility: n (%)"
)


# Build the matrix
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.static[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")

for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Finalize table
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Render with gt
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.6.2: Summary of Pregnancy and Labor by Outcomes**")) %>%

  # Group rows
  tab_row_group(label = "Fetal Presentation", rows = c(
    "Cephalic: n (%)", "Breech: n (%)", "Transverse lie: n (%)", 
    "Brow or face: n (%)", "Other: n (%)")) %>%

  tab_row_group(label = "Membrane Status", rows = c(
    "Spontaneous: n (%)", "Artificial: n (%)", "Not applicable: n (%)")) %>%

  tab_row_group(label = "Pregnancy Outcome", rows = "Preterm pregnancy endpoint (<37 weeks): n (%)") %>%

  tab_row_group(label = "Labor and Delivery", rows = c(
    "Experienced any labor: n (%)", "Prolonged labor: n (%)", "Obstructed labor: n (%)")) %>%

  tab_row_group(label = "Hemorrhage", rows = "Antepartum hemorrhage during ANC: n (%)") %>%
  tab_row_group(label = "Cesarean delivery", rows = "Cesarean delivery: n (%)") %>%
  tab_row_group(label = "Birth facility", rows = "Birth facility: n (%)") %>%

  row_group_order(c(NA,
    "Fetal Presentation", "Membrane Status", "Pregnancy Outcome",
    "Labor and Delivery", "Hemorrhage", "Cesarean delivery", "Birth facility"
  )) %>%

  # Add footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is full PRiSMA cohort")
  ) %>%
  gtsave("Pregnancy_Labor_Outcome.png", expand = 10)

# Show in RMarkdown
knitr::include_graphics("Pregnancy_Labor_Outcome.png")

```
## 2.7 Supplement
```{r}
matrix_demo_a <- data.temporal.wide %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),
 # Multiple Micronutrient
    "MMN supplement - enrollment: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_1 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_1 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_1)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC20: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_2 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_2 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_2)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC28: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_3 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_3 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_3)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC32: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_4 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_4 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_4)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC36: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_5 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_5 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_5)) * 100, digits = 1, nsmall = 0), ")"),
     ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.temporal.wide %>% 
      summarise(
"Expected denominator, n^a^" = n(),
# Multiple Micronutrient
    "MMN supplement - enrollment: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_1 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_1 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_1)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC20: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_2 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_2 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_2)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC28: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_3 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_3 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_3)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC32: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_4 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_4 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_4)) * 100, digits = 1, nsmall = 0), ")"),

    "MMN supplement - ANC36: n (%)" = paste0(sum(M04_MICRONUTRIENT_CMOCCUR_5 == 1, na.rm = TRUE), " (", format(sum(M04_MICRONUTRIENT_CMOCCUR_5 == 1, na.rm = TRUE) / sum(!is.na(M04_MICRONUTRIENT_CMOCCUR_5)) * 100, digits = 1, nsmall = 0), ")"),
    ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 2.7.1: Summary of Supplement by Site**")
  ) %>% 
  tab_row_group(
    label = "Multiple Micronutrients (MMN)",
    rows = 2:6
  ) %>% 

  row_group_order(groups = c(NA,
    "Multiple Micronutrients (MMN)"
  )) %>% 
  
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is the PRiSMA cohort; observed denominator includes those with non-missing results.")
  ) %>%
  
  gtsave("Supplement_Summary.png", expand = 10)

knitr::include_graphics("Supplement_Summary.png")
```
```{r}
# Variable display names
vars <- c(
  "M04_MICRONUTRIENT_CMOCCUR_1" = "MMN supplement - enrollment: n (%)",
  "M04_MICRONUTRIENT_CMOCCUR_2" = "MMN supplement - ANC20: n (%)",
  "M04_MICRONUTRIENT_CMOCCUR_3" = "MMN supplement - ANC28: n (%)",
  "M04_MICRONUTRIENT_CMOCCUR_4" = "MMN supplement - ANC32: n (%)",
  "M04_MICRONUTRIENT_CMOCCUR_5" = "MMN supplement - ANC36: n (%)"
)

# Build matrix
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.temporal.wide[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")

for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Combine and prepare
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Render gt table
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.7.2: Summary of Supplement by Outcomes**")) %>%
  tab_row_group(label = "Multiple Micronutrients (MMN)", rows = 2:6) %>%
  row_group_order(groups = c(NA, "Multiple Micronutrients (MMN)")) %>%
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort")
  ) %>%
  gtsave("Supplement_Outcome.png", expand = 10)

# Display in RMarkdown
knitr::include_graphics("Supplement_Outcome.png")

```
## 2.8 Micronutrients
```{r}
matrix_demo_a <- data.temporal.wide %>% 
  group_by(SITE) %>% 
  summarise(
"Expected denominator, n^a^" = n(),
# Ferritin
"Ferritin - Enrollment: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC20: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC28: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC32: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC36: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
# TIBC
"TIBC - Enrollment: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC20: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC28: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC32: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC36: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
# Hepcidin
"Hepcidin - Enrollment: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC20: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC28: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC32: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC36: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), ")"), 
     ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = data.temporal.wide %>% 
      summarise(
"Expected denominator, n^a^" = n(),
# Ferritin
"Ferritin - Enrollment: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC20: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC28: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC32: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Ferritin - ANC36: mean (SD)" = paste0(format(mean(M08_FERRITIN_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_FERRITIN_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
# TIBC
"TIBC - Enrollment: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC20: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC28: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC32: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"TIBC - ANC36: mean (SD)" = paste0(format(mean(M08_IRON_TOT_UGDL_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_TOT_UGDL_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
# Hepcidin
"Hepcidin - Enrollment: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_1, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC20: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_2, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC28: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_3, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC32: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_4, na.rm = TRUE), digits = 1, nsmall = 0), ")"),
"Hepcidin - ANC36: mean (SD)" = paste0(format(mean(M08_IRON_HEP_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), " (", format(sd(M08_IRON_HEP_LBORRES_5, na.rm = TRUE), digits = 1, nsmall = 0), ")"), 
      ) %>% 
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>% 
  tab_header(
    title = md("**Table 2.8.1: Summary of Iron Biomarker by Site**")
  ) %>% 

  # Grouping Rows
  tab_row_group(
    label = "Ferritin (µg/dL)",
    rows = 2:6
  ) %>% 
  tab_row_group(
    label = "Total Iron-Binding Capacity (TIBC, µg/dL)",
    rows = 7:11
  ) %>% 
  tab_row_group(
    label = "Hepcidin (ng/mL)",
    rows = 12:16
  ) %>% 
  row_group_order(groups = c(NA,
    "Ferritin (µg/dL)", 
    "Total Iron-Binding Capacity (TIBC, µg/dL)",
    "Hepcidin (ng/mL)"
  )) %>% 
  
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is the PRiSMA cohort; observed denominator includes those with non-missing results.")
  ) %>%
  
  gtsave("Micronutrient_Iron_Biomarkers_Summary.png", expand = 10)

knitr::include_graphics("Micronutrient_Iron_Biomarkers_Summary.png")

```
```{r}
# Variables
vars <- c(
  "M08_FERRITIN_LBORRES_1" = "Ferritin - Enrollment: mean (SD)",
  "M08_FERRITIN_LBORRES_2" = "Ferritin - ANC20: mean (SD)",
  "M08_FERRITIN_LBORRES_3" = "Ferritin - ANC28: mean (SD)",
  "M08_FERRITIN_LBORRES_4" = "Ferritin - ANC32: mean (SD)",
  "M08_FERRITIN_LBORRES_5" = "Ferritin - ANC36: mean (SD)",
  "M08_IRON_TOT_UGDL_LBORRES_1" = "TIBC - Enrollment: mean (SD)",
  "M08_IRON_TOT_UGDL_LBORRES_2" = "TIBC - ANC20: mean (SD)",
  "M08_IRON_TOT_UGDL_LBORRES_3" = "TIBC - ANC28: mean (SD)",
  "M08_IRON_TOT_UGDL_LBORRES_4" = "TIBC - ANC32: mean (SD)",
  "M08_IRON_TOT_UGDL_LBORRES_5" = "TIBC - ANC36: mean (SD)",
  "M08_IRON_HEP_LBORRES_1" = "Hepcidin - Enrollment: mean (SD)",
  "M08_IRON_HEP_LBORRES_2" = "Hepcidin - ANC20: mean (SD)",
  "M08_IRON_HEP_LBORRES_3" = "Hepcidin - ANC28: mean (SD)",
  "M08_IRON_HEP_LBORRES_4" = "Hepcidin - ANC32: mean (SD)",
  "M08_IRON_HEP_LBORRES_5" = "Hepcidin - ANC36: mean (SD)"
)

# Create matrix
matrix_demo_a <- tibble(Covariates = vars)
for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    mean_sd(data.temporal.wide[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")
for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Render table
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.8.2: Summary of Iron Biomarker by Outcomes**")) %>%
  tab_row_group(label = "Ferritin (µg/dL)", rows = vars[1:5]) %>%
  tab_row_group(label = "Total Iron-Binding Capacity (TIBC, µg/dL)", rows = vars[6:10]) %>%
  tab_row_group(label = "Hepcidin (ng/mL)", rows = vars[11:15]) %>%
  row_group_order(c(NA, "Ferritin (µg/dL)", "Total Iron-Binding Capacity (TIBC, µg/dL)","Hepcidin (ng/mL)")) %>%
  tab_footnote(footnote = html("<sup>a</sup> Expected denominator is PRiSMA cohort")) %>%
  gtsave("Micronutrient_Iron_Biomarkers_Outcome.png", expand = 10)

knitr::include_graphics("Micronutrient_Iron_Biomarkers_Outcome.png")

```
## 2.9 Ultrasound
```{r}
matrix_demo_a <- data.static %>%
  group_by(SITE) %>%
  summarise(
    "Expected denominator, n^a^" = n(),
    # Fetus number
    # Single
    "Single: n (%)" = paste0(
      sum(NUM_FETUS == 1, na.rm = TRUE), " (",
      format(sum(NUM_FETUS == 1, na.rm = TRUE) / sum(!is.na(NUM_FETUS)) * 100, digits = 1, nsmall = 0), ")"),

    # Twin
    "Twin: n (%)" = paste0(
      sum(NUM_FETUS == 2, na.rm = TRUE), " (",
      format(sum(NUM_FETUS == 2, na.rm = TRUE) / sum(!is.na(NUM_FETUS)) * 100, digits = 1, nsmall = 0), ")"),

    # Triplets
    "Triplets: n (%)" = paste0(
      sum(NUM_FETUS == 3, na.rm = TRUE), " (",
      format(sum(NUM_FETUS == 3, na.rm = TRUE) / sum(!is.na(NUM_FETUS)) * 100, digits = 1, nsmall = 0), ")"),
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(.[1,]) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = data.static %>%
      summarise(
        "Expected denominator, n^a^" = n(),
        "Single: n (%)" = paste0(
          sum(NUM_FETUS == 1, na.rm = TRUE), " (",
          format(sum(NUM_FETUS == 1, na.rm = TRUE) / sum(!is.na(NUM_FETUS)) * 100, digits = 1, nsmall = 0), ")"),

        "Twin: n (%)" = paste0(
          sum(NUM_FETUS == 2, na.rm = TRUE), " (",
          format(sum(NUM_FETUS == 2, na.rm = TRUE) / sum(!is.na(NUM_FETUS)) * 100, digits = 1, nsmall = 0), ")"),

        "Triplets: n (%)" = paste0(
          sum(NUM_FETUS == 3, na.rm = TRUE), " (",
          format(sum(NUM_FETUS == 3, na.rm = TRUE) / sum(!is.na(NUM_FETUS)) * 100, digits = 1, nsmall = 0), ")"),
      ) %>%
      t() %>% unlist()
  )

tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.9.1: Summary of Ultrasound Characteristics by Site**")) %>%

  # Add row groups
  tab_row_group(label = "Fetus number", rows = 2:4) %>%
  row_group_order(groups = c(NA,
    "Fetus number"
  )) %>%

  # Add footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is full PRiSMA cohort; observed denominator reflects available data.")
  ) %>%
  
  gtsave("Ultrasound_summary.png", expand = 10)

knitr::include_graphics("Ultrasound_summary.png")

```
```{r}
# Define variables and labels
vars <- c(
  "NUM_FETUS_1" = "Single: n (%)",
  "NUM_FETUS_2" = "Twin: n (%)",
  "NUM_FETUS_3" = "Triplets: n (%)"
)

# Create derived binary indicators for number of fetuses
data.static <- data.static %>%
  mutate(
    NUM_FETUS_1 = ifelse(NUM_FETUS == 1, 1, ifelse(!is.na(NUM_FETUS), 0, NA)),
    NUM_FETUS_2 = ifelse(NUM_FETUS == 2, 1, ifelse(!is.na(NUM_FETUS), 0, NA)),
    NUM_FETUS_3 = ifelse(NUM_FETUS == 3, 1, ifelse(!is.na(NUM_FETUS), 0, NA))
  )


# Build matrix
matrix_demo_a <- tibble(Covariates = vars)

for (label in names(outcome_filters)) {
  matrix_demo_a[[label]] <- sapply(names(vars), function(v) {
    n_pct(data.static[outcome_filters[[label]], ], v)
  })
}

# Add expected denominator row
denominator_row <- tibble(Covariates = "Expected denominator, n^a^")
for (label in names(outcome_filters)) {
  denominator_row[[label]] <- as.character(sum(outcome_filters[[label]], na.rm = TRUE))
}

# Finalize structure
matrix_demo_a <- bind_rows(denominator_row, matrix_demo_a) %>%
  column_to_rownames(var = "Covariates")

# Format with gt
tb_demo_a <- tb_theme1(matrix_demo_a) %>%
  tab_header(title = md("**Table 2.9.2: Summary of Ultrasound Characteristics by Outcomes**")) %>%

  # Row groupings
  tab_row_group(label = "Fetus number", rows = c("Single: n (%)", "Twin: n (%)", "Triplets: n (%)")) %>%
  row_group_order(c(NA, "Fetus number")) %>%

  # Footnote
  tab_footnote(
    footnote = html("<sup>a</sup> Expected denominator is full PRiSMA cohort")
  ) %>%
  gtsave("Ultrasound_Outcome.png", expand = 10)

# Display image in RMarkdown
knitr::include_graphics("Ultrasound_Outcome.png")

```
